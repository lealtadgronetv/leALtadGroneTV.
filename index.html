<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream HLS</title>
    <!-- Versión alternativa de HLS.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.3.5/hls.min.js"></script>
    <style>
        body { margin: 0; padding: 10px; font-family: Arial; }
        video { width: 100%; max-width: 800px; background: #000; }
        .controls { margin: 10px 0; }
        #error { color: red; font-weight: bold; }
        .ads { border: 1px dashed #ccc; padding: 10px; margin: 10px 0; text-align: center; }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="streamUrl" placeholder="URL del stream" value="http://localhost:8080/hls/test.m3u8" style="width: 70%;">
        <button id="loadBtn">Cargar</button>
    </div>
    
    <div id="error"></div>
    <video id="videoPlayer" controls></video>
    
    <div class="ads">Espacio publicitario</div>
    
    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const streamUrl = document.getElementById('streamUrl');
        const loadBtn = document.getElementById('loadBtn');
        const errorDisplay = document.getElementById('error');
        let hlsPlayer = null;
        
        // Función para mostrar errores
        function showError(msg) {
            errorDisplay.textContent = msg;
            console.error(msg);
        }
        
        // Función para limpiar errores
        function clearError() {
            errorDisplay.textContent = '';
        }
        
        // Función para cargar el stream
        function loadStream(url) {
            clearError();
            
            // Limpiar instancia previa
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // Restablecer el reproductor
            videoPlayer.src = '';
            videoPlayer.load();
            
            // Verificar si la URL parece válida
            if (!url.startsWith('http')) {
                showError('La URL debe comenzar con http:// o https://');
                return;
            }
            
            try {
                // Probar primero con reproducción nativa para Safari y iOS
                if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    videoPlayer.src = url;
                    videoPlayer.addEventListener('loadedmetadata', () => {
                        videoPlayer.play();
                    });
                    videoPlayer.addEventListener('error', (e) => {
                        showError(`Error en reproducción nativa: ${videoPlayer.error?.message || 'Desconocido'}`);
                    });
                    return;
                }
                
                // Para otros navegadores, usar HLS.js
                if (Hls.isSupported()) {                    
                    hlsPlayer = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        // Configuraciones para manifestLoadError
                        manifestLoadingMaxRetry: 8,
                        manifestLoadingRetryDelay: 500,
                        manifestLoadingTimeOut: 20000,
                        // Desactivar CORS para pruebas locales
                        xhrSetup: function(xhr) {
                            xhr.withCredentials = false;
                        }
                    });
                    
                    hlsPlayer.loadSource(url);
                    hlsPlayer.attachMedia(videoPlayer);
                    
                    hlsPlayer.on(Hls.Events.MEDIA_ATTACHED, () => {
                        videoPlayer.play();
                    });
                    
                    hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                        console.log("Error HLS:", data);
                        
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR && 
                            data.details === 'manifestLoadError') {
                            
                            // Información de depuración detallada
                            let errorMsg = `Error cargando manifest. `;
                            if (data.response) {
                                errorMsg += `Código: ${data.response.code}, `;
                                errorMsg += `Texto: ${data.response.text || 'N/A'}`;
                            }
                            
                            showError(errorMsg);
                            
                            // Sugerencias según el error
                            if (!data.response || data.response.code === 0) {
                                showError(errorMsg + "\n\nPosibles soluciones: 1) Verifica que el servidor esté ejecutándose. 2) La URL puede estar mal formada. 3) Problema de CORS - el servidor debe permitir acceso desde este origen.");
                            }
                        }
                        
                        // Intentar recuperarse de errores fatales
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    showError("Error de red. Reintentando...");
                                    setTimeout(() => hlsPlayer.startLoad(), 2000);
                                    break;
                                    
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    showError("Error de reproducción. Intentando recuperar...");
                                    hlsPlayer.recoverMediaError();
                                    break;
                                    
                                default:
                                    showError("Error fatal en HLS.js. Recarga la página.");
                                    break;
                            }
                        }
                    });
                } else {
                    showError('Tu navegador no soporta HLS');
                }
            } catch (e) {
                showError(`Error al inicializar: ${e.message}`);
            }
        }
        
        // Event listeners
        loadBtn.addEventListener('click', () => {
            loadStream(streamUrl.value.trim());
        });
        
        streamUrl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadStream(streamUrl.value.trim());
            }
        });
        
        // Cargar automáticamente
        window.addEventListener('DOMContentLoaded', () => {
            // Esperar un poco para asegurarse que todo está cargado
            setTimeout(() => {
                loadStream(streamUrl.value.trim());
            }, 500);
        });
    </script>
</body>
</html>
