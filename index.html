<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream HLS</title>
    <!-- Versión alternativa de HLS.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.3.5/hls.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #f5f8ff;
            --text-color: #333;
            --error-color: #e53935;
            --border-radius: 8px;
        }
        
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .video-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            background: #000;
        }
        
        video { 
            width: 100%; 
            display: block;
            background: #000; 
        }
        
        .controls {
            margin: 15px 0;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            outline: none;
            transition: border 0.3s;
        }
        
        input:focus {
            border-color: var(--primary-color);
        }
        
        #error { 
            color: var(--error-color); 
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffebee;
            border-radius: var(--border-radius);
            display: none;
        }
        
        #error.visible {
            display: block;
        }
        
        /* BLOQUES DE PUBLICIDAD - AGREGAR ADS AQUÍ */
        .ad-container {
            margin: 20px 0;
        }
        
        .ad-container .ad-label {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        /* Bloque de publicidad superior */
        .ad-top {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            min-height: 90px;
        }
        
        /* Bloque de publicidad inferior */
        .ad-bottom {
            border: 1px solid #eee;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            min-height: 250px;
        }
        
        /* Publicidad lateral (para pantallas más grandes) */
        .ad-side {
            border: 1px solid #eee;
            padding: 15px;
            text-align: center;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            min-height: 600px;
        }
        
        /* Diseño responsive */
        .content-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .main-content {
            flex: 1 1 600px;
        }
        
        .sidebar {
            flex: 0 0 300px;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }
        
        @media (max-width: 900px) {
            .sidebar {
                flex: 1 1 100%;
            }
            
            .ad-side {
                min-height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reproductor de Video HLS</h1>
        
        <!-- BLOQUE DE PUBLICIDAD SUPERIOR -->
        <div class="ad-container">
            <div class="ad-label">Publicidad</div>
            <div class="ad-top">
                <!-- INSERTAR CÓDIGO DE PUBLICIDAD AQUÍ -->
                Espacio para anuncio superior (728x90)
            </div>
        </div>
        
        <div class="content-wrapper">
            <div class="main-content">
                <div class="controls">
                    <input type="text" id="streamUrl" placeholder="URL del stream" value="http://localhost:8080/hls/test.m3u8">
                </div>
                
                <div id="error"></div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls></video>
                </div>
                
                <!-- BLOQUE DE PUBLICIDAD INFERIOR -->
                <div class="ad-container">
                    <div class="ad-label">Publicidad</div>
                    <div class="ad-bottom">
                        <!-- INSERTAR CÓDIGO DE PUBLICIDAD AQUÍ -->
                        Espacio para anuncio inferior (728x250)
                    </div>
                </div>
            </div>
            
            <!-- BLOQUE DE PUBLICIDAD LATERAL -->
            <div class="sidebar">
                <div class="ad-container">
                    <div class="ad-label">Publicidad</div>
                    <div class="ad-side">
                        <!-- INSERTAR CÓDIGO DE PUBLICIDAD AQUÍ -->
                        Espacio para anuncio lateral (300x600)
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            &copy; 2025 Reproductor HLS - Todos los derechos reservados
        </footer>
    </div>
    
    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const streamUrl = document.getElementById('streamUrl');
        const errorDisplay = document.getElementById('error');
        let hlsPlayer = null;
        
        // Función para mostrar errores
        function showError(msg) {
            errorDisplay.textContent = msg;
            errorDisplay.classList.add('visible');
            console.error(msg);
        }
        
        // Función para limpiar errores
        function clearError() {
            errorDisplay.textContent = '';
            errorDisplay.classList.remove('visible');
        }
        
        // Función para cargar el stream
        function loadStream(url) {
            clearError();
            
            // Limpiar instancia previa
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // Restablecer el reproductor
            videoPlayer.src = '';
            videoPlayer.load();
            
            // Verificar si la URL parece válida
            if (!url.startsWith('http')) {
                showError('La URL debe comenzar con http:// o https://');
                return;
            }
            
            try {
                // Probar primero con reproducción nativa para Safari y iOS
                if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    videoPlayer.src = url;
                    videoPlayer.addEventListener('loadedmetadata', () => {
                        videoPlayer.play();
                    });
                    videoPlayer.addEventListener('error', (e) => {
                        showError(`Error en reproducción nativa: ${videoPlayer.error?.message || 'Desconocido'}`);
                    });
                    return;
                }
                
                // Para otros navegadores, usar HLS.js
                if (Hls.isSupported()) {                    
                    hlsPlayer = new Hls({
                        enableWorker: true,
                        lowLatencyMode: true,
                        backBufferLength: 90,
                        // Configuraciones para manifestLoadError
                        manifestLoadingMaxRetry: 8,
                        manifestLoadingRetryDelay: 500,
                        manifestLoadingTimeOut: 20000,
                        // Desactivar CORS para pruebas locales
                        xhrSetup: function(xhr) {
                            xhr.withCredentials = false;
                        }
                    });
                    
                    hlsPlayer.loadSource(url);
                    hlsPlayer.attachMedia(videoPlayer);
                    
                    hlsPlayer.on(Hls.Events.MEDIA_ATTACHED, () => {
                        videoPlayer.play();
                    });
                    
                    hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                        console.log("Error HLS:", data);
                        
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR && 
                            data.details === 'manifestLoadError') {
                            
                            // Información de depuración detallada
                            let errorMsg = `Error cargando manifest. `;
                            if (data.response) {
                                errorMsg += `Código: ${data.response.code}, `;
                                errorMsg += `Texto: ${data.response.text || 'N/A'}`;
                            }
                            
                            showError(errorMsg);
                            
                            // Sugerencias según el error
                            if (!data.response || data.response.code === 0) {
                                showError(errorMsg + "\n\nPosibles soluciones: 1) Verifica que el servidor esté ejecutándose. 2) La URL puede estar mal formada. 3) Problema de CORS - el servidor debe permitir acceso desde este origen.");
                            }
                        }
                        
                        // Intentar recuperarse de errores fatales
                        if (data.fatal) {
                            switch (data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    showError("Error de red. Reintentando...");
                                    setTimeout(() => hlsPlayer.startLoad(), 2000);
                                    break;
                                    
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    showError("Error de reproducción. Intentando recuperar...");
                                    hlsPlayer.recoverMediaError();
                                    break;
                                    
                                default:
                                    showError("Error fatal en HLS.js. Recarga la página.");
                                    break;
                            }
                        }
                    });
                } else {
                    showError('Tu navegador no soporta HLS');
                }
            } catch (e) {
                showError(`Error al inicializar: ${e.message}`);
            }
        }
        
        // Event listener para cargar cuando se presiona Enter
        streamUrl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadStream(streamUrl.value.trim());
            }
        });
        
        // Event listener para cargar cuando el campo pierde el foco
        streamUrl.addEventListener('blur', () => {
            loadStream(streamUrl.value.trim());
        });
        
        // Cargar automáticamente
        window.addEventListener('DOMContentLoaded', () => {
            // Esperar un poco para asegurarse que todo está cargado
            setTimeout(() => {
                loadStream(streamUrl.value.trim());
            }, 500);
        });
    </script>
</body>
</html>
