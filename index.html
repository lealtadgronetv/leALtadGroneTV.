<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream HLS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.3.5/hls.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #f5f8ff;
            --text-color: #333;
            --error-color: #e53935;
            --border-radius: 8px;
        }
        
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f9f9f9;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .video-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            background: #000;
        }
        
        video { 
            width: 100%; 
            display: block;
            background: #000; 
        }
        
        /* Campo URL visible para pruebas */
        .url-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }
        
        .load-button {
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        #error { 
            color: var(--error-color); 
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffebee;
            border-radius: var(--border-radius);
            display: none;
        }
        
        #error.visible {
            display: block;
        }
        
        /* Estilos para publicidad */
        .ad-container {
            margin: 20px 0;
        }
        
        .ad-container .ad-label {
            text-align: center;
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .ad-top {
            text-align: center;
            margin-bottom: 20px;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Reproductor de Video HLS</h1>
        
        <div class="content-wrapper">
            <div class="main-content">
                <!-- Campo visible para pruebas -->
                <input type="text" id="streamUrl" class="url-input" placeholder="URL del stream (ej: https://example.com/stream.m3u8)">
                <button id="loadButton" class="load-button">Cargar Stream</button>
                
                <div id="error"></div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls playsinline muted></video>
                </div>
            </div>
        </div>
        
        <footer>
            &copy; 2025 Reproductor HLS - Todos los derechos reservados
        </footer>
    </div>
    
    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const streamUrl = document.getElementById('streamUrl');
        const loadButton = document.getElementById('loadButton');
        const errorDisplay = document.getElementById('error');
        let hlsPlayer = null;
        
        // Función para mostrar errores
        function showError(msg) {
            errorDisplay.textContent = msg;
            errorDisplay.classList.add('visible');
            console.error(msg);
        }
        
        // Función para limpiar errores
        function clearError() {
            errorDisplay.textContent = '';
            errorDisplay.classList.remove('visible');
        }
        
        // Función para cargar el stream
        function loadStream(url) {
            clearError();
            
            // Limpiar instancia previa
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // Restablecer el reproductor
            videoPlayer.src = '';
            videoPlayer.load();
            
            // Verificar si la URL parece válida
            if (!url.startsWith('http')) {
                showError('La URL debe comenzar con http:// o https://');
                return;
            }
            
            // Deshabilitar el atributo muted después de la interacción del usuario
            videoPlayer.muted = false;
            
            try {
                // Probar primero con reproducción nativa para Safari y iOS
                if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    console.log("Usando reproducción nativa HLS");
                    videoPlayer.src = url;
                    
                    // Mejorar la gestión de errores para reproducción nativa
                    videoPlayer.addEventListener('loadedmetadata', () => {
                        videoPlayer.play().catch(e => {
                            console.error("Error al reproducir:", e);
                            // Intentar con reproducción silenciosa si falla la reproducción automática
                            videoPlayer.muted = true;
                            videoPlayer.play();
                        });
                    });
                    
                    videoPlayer.addEventListener('error', (e) => {
                        const error = videoPlayer.error;
                        let errorMsg = "Error en reproducción nativa";
                        
                        if (error) {
                            // Códigos de error según la especificación de HTML5 Media
                            switch (error.code) {
                                case 1: // MEDIA_ERR_ABORTED
                                    errorMsg += ": La reproducción fue abortada por el usuario";
                                    break;
                                case 2: // MEDIA_ERR_NETWORK
                                    errorMsg += ": Error de red al cargar el medio";
                                    break;
                                case 3: // MEDIA_ERR_DECODE
                                    errorMsg += ": Error de decodificación del formato";
                                    break;
                                case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                                    errorMsg += ": El formato o tipo de medio no es soportado";
                                    break;
                                default:
                                    errorMsg += `: Código de error ${error.code}`;
                            }
                            
                            if (error.message) {
                                errorMsg += ` - ${error.message}`;
                            }
                        }
                        
                        showError(errorMsg);
                        
                        // Fallback a HLS.js si la reproducción nativa falla y HLS.js está disponible
                        if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                            console.log("Fallback a HLS.js después de error nativo");
                            initHlsPlayer(url);
                        }
                    });
                } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
                    // Para otros navegadores, usar HLS.js
                    initHlsPlayer(url);
                } else {
                    showError('Tu navegador no soporta HLS');
                }
            } catch (e) {
                showError(`Error al inicializar: ${e.message}`);
            }
        }
        
        // Función para inicializar HLS.js
        function initHlsPlayer(url) {
            console.log("Inicializando HLS.js");
            
            hlsPlayer = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90,
                manifestLoadingMaxRetry: 8,
                manifestLoadingRetryDelay: 500,
                manifestLoadingTimeOut: 20000,
                fragLoadingMaxRetry: 8,
                fragLoadingRetryDelay: 500,
                fragLoadingTimeOut: 20000,
                // Desactivar CORS para pruebas
                xhrSetup: function(xhr) {
                    xhr.withCredentials = false;
                }
            });
            
            hlsPlayer.loadSource(url);
            hlsPlayer.attachMedia(videoPlayer);
            
            hlsPlayer.on(Hls.Events.MEDIA_ATTACHED, () => {
                videoPlayer.play().catch(e => {
                    console.error("Error al reproducir con HLS.js:", e);
                    // Intentar con reproducción silenciosa si falla la reproducción automática
                    videoPlayer.muted = true;
                    videoPlayer.play();
                });
            });
            
            hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                console.log("Error HLS:", data);
                
                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    let errorMsg = `Error de red: `;
                    
                    if (data.details === 'manifestLoadError') {
                        errorMsg += `Error cargando manifest. `;
                        if (data.response) {
                            errorMsg += `Código: ${data.response.code}, `;
                            errorMsg += `Texto: ${data.response.text || 'N/A'}`;
                        }
                        
                        // Sugerencias según el error
                        if (!data.response || data.response.code === 0) {
                            errorMsg += "\n\nPosibles soluciones: 1) Verifica que el servidor esté accesible. 2) La URL puede estar mal formada. 3) Problema de CORS - el servidor debe permitir acceso desde este origen.";
                        }
                    } else if (data.details === 'fragLoadError') {
                        errorMsg += `Error cargando fragmento. `;
                    }
                    
                    showError(errorMsg);
                }
                
                // Intentar recuperarse de errores fatales
                if (data.fatal) {
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            showError("Error de red. Reintentando...");
                            setTimeout(() => hlsPlayer.startLoad(), 2000);
                            break;
                            
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            showError("Error de reproducción. Intentando recuperar...");
                            hlsPlayer.recoverMediaError();
                            break;
                            
                        default:
                            showError("Error fatal en HLS.js. Recarga la página.");
                            break;
                    }
                }
            });
        }
        
        // Detectar si estamos en móvil
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Establecer una URL de prueba o la URL predeterminada
        // Cambia esto por la URL real de tu stream
        streamUrl.value = isMobile ? "https://2bb6-38-172-130-234.ngrok-free.app/hls/test.m3u8" : "https://2bb6-38-172-130-234.ngrok-free.app/hls/test.m3u8";
        
        // Evento para cargar el stream
        loadButton.addEventListener('click', () => {
            loadStream(streamUrl.value.trim());
        });
        
        // Si se detecta móvil, añadir algunas modificaciones especiales
        if (isMobile) {
            // Asegurarse de que el atributo playsinline esté presente
            videoPlayer.setAttribute('playsinline', '');
            // Añadir autoplay como último recurso para iOS
            videoPlayer.setAttribute('autoplay', '');
        }
        
        // Cargar automáticamente al cargar la página
        window.addEventListener('DOMContentLoaded', () => {
            // Esperar un poco para asegurarse que todo está cargado
            setTimeout(() => {
                loadStream(streamUrl.value.trim());
            }, 500);
        });
    </script>
</body>
</html>
